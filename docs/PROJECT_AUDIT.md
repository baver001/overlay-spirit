# Аудит проекта «Loverlay»

## 1. Резюме
- Проект представляет собой PWA-редактор оверлеев на React/Vite с клиентским рендерингом и набором Cloudflare Pages Functions для аутентификации, управления контентом и интеграции Stripe.
- Кодовая база во многом унаследована от шаблонов Lovable (shadcn/ui, Radix, Tailwind); заметно дублирование логики и незавершённая реализация коммерческих возможностей.
- Критические риски: дублированное состояние редактора (`App.tsx` и `pages/Index.tsx`), нерабочий маршрут `/editor`, неподтверждённые Stripe webhook-и, публичный `/api/migrate` с полной пересозданием БД.

## 2. Архитектура
- **Frontend**: `React 18`, `Vite`, `TypeScript` (параметры строгости отключены), дизайн-система shadcn/ui + Tailwind. Входная точка `src/main.tsx` → `App.tsx` → маршруты `/` (основной редактор) и `/editor` (дублирующий интерфейс).
- **State management**: локальный стейт в компонентах, `React Query` подключён, но не используется. Нет глобального стора/контекста для изображения и оверлеев.
- **Backend**: Cloudflare Pages Functions (`functions/api/*`) — аутентификация, админ CRUD, Stripe checkout/webhook, прокси к R2, миграции.
- **Данные**: предполагается Cloudflare D1; `schema.sql` описывает пользователей, сессии, категории, наборы, оверлеи, покупки и usage_stats. В UI данные загружаются из статического `overlayData.ts`, ДБ не используется.
- **Инфраструктура**: Vite build, npm (`package-lock.json`), bun lock присутствует, но не используется. CI/CD отсутствует.

## 3. Frontend аудит
- **Навигация и состояние**: `App.tsx` и `Index.tsx` содержат независимые копии логики работы с изображением/оверлеями. Маршрут `/editor` получает пустые данные, так как стейт в `App.tsx` не связан с `Index`. Требуется единый источник данных (контекст/Zustand) или удаление `/editor`.
- **Производительность/UX**: размеры холста рассчитываются от `window.innerWidth`, но отсутствует обработка resize; drag&drop не поддерживает touch. Нет undo/redo, горячих клавиш. `ImageDropzone` корректна, но отсутствует прогресс/превью.
- **Качество кода**: в `OverlaysPanel` остались `console.log`; типы `Overlay` ограничены (blendMode без всего множества). TS-инженерные флаги ослаблены (`strict:false`).
- **Доступность**: иконки-кнопки (`OverlayControls`, `ImageManager`) без `aria-label`; модалки/панели без фокус-ловушек (кроме Radix).
- **Платёжная логика**: CTA «Купить набор» не подключён к Stripe, нет проверки авторизации/покупок.

## 4. Backend аудит
- **Auth (`functions/api/auth.ts`)**: пароли сверяются через SHA-256 без соли; нет лимитеров, нет CSRF токенов. `SESSION_SECRET` не используется.
- **Admin API**: авторизация по sid-cookie, но отсутствует валидация входа (нужен schema validator, например Zod) и audit logging. Нет rate limiting.
- **Stripe (`stripe.ts`)**: webhook проверяется через REST-запрос `events/{id}` без подписи (`STRIPE_WEBHOOK_SECRET`) — возможно спуфинг. На оплату создаётся запись, но нет обработки ошибок при обновлении статуса.
- **Миграции (`migrate.ts`)**: публичный POST полностью пересобирает схему → критический риск. Нужно ограничить окружением или удалить из продакшена.
- **Files proxy (`files.ts`)**: отдаёт любой ключ из R2 без ACL; при наличии приватных ассетов требуется ограничить по префиксу или выдавать подписанные URL.

## 5. Данные и бизнес-логика
- UI использует статический каталог (`overlayData.ts`); данные из D1 не читаются — отсутствует фактическая интеграция бэкенда.
- Таблица `usage_stats` не используется.
- Нет сохранения пользовательских проектов/оверлеев; только локальное редактирование.

## 6. Инфраструктура и DevOps
- Нет CI. Рекомендуется GitHub Actions: `npm ci`, `npm run lint`, `npm run build`, `wrangler deploy`/Pages publish.
- Нет `.env.example` / инструкции по настройке (D1 binding, R2 bucket, Stripe keys).
- `wrangler.toml` не документирован (предполагаем наличие переменных).
- Vite dev server слушает IPv6 (`host ::`), что может создавать проблемы на Windows.

## 7. Безопасность
- Публичный `/api/migrate`.
- Отсутствуют security headers (CSP, COOP/COEP). Использовать Cloudflare Headers.
- Нет rate limiting, нет мониторинга/alerting.
- Хранение паролей без соли/pepper.

## 8. Тестирование и качество
- Тесты отсутствуют (unit/e2e).
- ESLint подключён (см. `eslint.config.js`), но нет интеграции в CI.
- TypeScript не в строгом режиме, что скрывает ошибки.

## 9. Рекомендации (приоритеты)
1. **Критично**
   - Отключить/защитить `/api/migrate` в продуктиве.
   - Рефакторить маршрутизацию: единый стор для изображения/оверлеев, исправить `/editor`.
   - Добавить верификацию подписи Stripe webhook и надёжную обработку ошибок.
   - Перейти на безопасные пароли (bcrypt/scrypt) и внедрить CSRF защиту.
2. **Высокий приоритет**
   - Подключить реальные данные из D1 (категории/наборы), интегрировать React Query.
   - Реализовать Stripe checkout/разблокировку наборов в UI.
   - Добавить обработку resize/touch, убрать `console.log`, улучшить a11y.
   - Усилить TS (включить `strict`), настроить ESLint/Prettier пайплайн.
3. **Средний приоритет**
   - Подготовить документацию по запуску и `.env.example`.
   - Создать unit тесты (hooks, utils) и e2e (Playwright) для основных сценариев.
   - Добавить Undo/Redo и экспорт итогового изображения с настройками качества.
4. **Низкий приоритет**
   - Реализовать сохранение пользовательских проектов (Cloudflare KV/D1).
   - Включить аналитики (usage_stats, Sentry/LogRocket).

## 10. Метрики успеха
- 0 публичных endpoint без авторизации.
- Lighthouse Performance/Best Practices ≥ 80, Accessibility ≥ 85.
- ≤1% невалидных Stripe webhook событий.
- Покрытие тестами ключевых функций ≥ 40%.

## 11. Следующие шаги
См. `docs/DEVELOPMENT_PLAN.md` для детального плана реализации.
