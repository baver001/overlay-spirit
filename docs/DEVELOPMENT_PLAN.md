# План разработки «Loverlay»

## 1. Цели
- Превратить MVP-редактор оверлеев в продукт с безопасной аутентификацией, платёжными сценариями, админ-панелью и удобным мобильным UX.
- Устранить критические уязвимости и технический долг.
- Подготовить основу для масштабирования (каталог из БД, кабинет пользователя, аналитика).

## 2. Статус и исходные шаги
- Выполнен технический аудит (`docs/PROJECT_AUDIT.md`).
- Запущено обновление плана (текущий документ) и старт внедрения мер безопасности.
- Определены критические риски: публичный `/api/migrate`, неподтверждённые Stripe вебхуки, дублирование состояния редактора.

## 3. Этапы работ

### Этап 0. Безопасность и подготовка инфраструктуры (в процессе, недели 1–2)
- **Защитить `/api/migrate`**: секрет/заголовок или полное отключение в продакшене.
- **Пароли и сессии**: переход на bcrypt/scrypt, CSRF токены, `SameSite=strict`.
- **Stripe webhook**: проверка подписи через `stripe.webhooks.constructEvent`, централизованный лог.
- **Состояние редактора**: вынести изображение/оверлеи в контекст/Zustand, синхронизировать `/` и `/editor` или удалить дублирующий маршрут.
- **Документация окружения**: `.env.example`, описание Cloudflare binding (D1, R2, Stripe), чеклист для dev/prod.

### Этап 1. Подготовка к админ-панели (недели 3–4)
- **База данных**: доработать `schema.sql` (индексы, поля описаний, audit trail), написать миграции.
- **API слой**: расширить `functions/api/admin.ts` — строгая валидация (zod), пагинация, фильтры, единый формат ошибок.
- **R2 загрузки**: валидация MIME/размера, структура ключей (`overlays/sets/{id}`), сохранение метаданных (натуральные размеры).
- **Типы и клиенты**: создать TS-интерфейсы для админских сущностей, общий HTTP-клиент с auth guard.
- **UI-фрейм**: прототип layout `/admin` (Sidebar + Header), роутинг, защита по роли `admin`.

### Этап 2. Реализация админ-панели (недели 5–7)
- **CRUD разделы**: категории, наборы, оверлеи (формы, списки, сортировка, поиск).
- **Загрузчик ассетов**: drag&drop, предпросмотр, привязка файлов к наборам, очистка.
- **Статистика**: графики usage/purchases, фильтры, экспорт CSV.
- **Журнал действий**: запись в `admin_audit`, отображение истории изменений.
- **UI polishing**: уведомления (toast), подтверждение удаления, оптимизация запросов (React Query).

### Этап 3. Адаптивный мобильный UX (недели 8–9)
- **Responsive layout**: перестройка редактора, сайдбаров, модалок для <768px.
- **Touch/gesture support**: pointer events, pinch-to-zoom.
- **Performance**: `ResizeObserver`, оптимизация рендера оверлеев.
- **Доступность**: aria-label, фокус-ловушки, цветовые контрасты.

### Этап 4. Кабинет пользователя (недели 10–12)
- **Маршрут `/account`**: профиль, платёжные методы, история покупок, сессии.
- **Интеграция Stripe**: customer portal или API для управления картами/подписками.
- **UX**: фильтры, повторный доступ к купленным наборам, уведомления.

### Этап 5. Функционал «Поделиться» (недели 13–14)
- **Share links**: сохранение проектов в D1/KV, короткие slug.
- **Соц-шаринг**: Web Share API, OG-изображения через Worker.
- **Просмотр по ссылке**: read-only режим.

### Этап 6. Авторизация и провайдеры (недели 15–17)
- **Email+пароль**: завершить безопасную реализацию (задействовано на этапе 0).
- **OAuth**: интеграция Google/Apple (через внешний IdP или собственную реализацию PKCE).
- **UI/UX**: комбинированная форма входа, восстановление доступа, управление сессиями.

### Этап 7. Инфраструктура и качество (недели 18–19)
- **CI/CD**: GitHub Actions (lint, test, build, wrangler publish), превью окружения.
- **Тестирование**: unit, component, e2e (Playwright) для редактора, покупок, шаринга, кабинета.
- **Обсервация**: Sentry, Cloudflare Logs, метрики Stripe.
- **Аналитика**: заполнение `usage_stats`, dashboards в админке.

## 4. Планы ресурсов
- Команда: 1 frontend, 1 backend/cloudflare, 1 дизайнер/UX (этапы 2–3), QA с этапа 3, DevOps на этапе 7.
- Оценка сроков (при 2 dev): ~19 недель, возможна параллельная работа (например, backend готовит API, frontend — UI).

## 5. Риски и смягчение
- **OAuth/Apple ID**: долгий аппрув → начинать интеграцию заранее, рассмотреть Auth0/Clerk/ Supabase Auth.
- **Stripe**: sandbox тесты, fallback на ручные invoices.
- **Cloudflare лимиты**: мониторинг D1/R2, план миграции при росте.
- **Технический долг**: строгие lint/ts, код-ревью.
- **Юридические требования**: подготовить политику возвратов, хранение логов оплат.

## 6. Deliverables
- Админ-панель `/admin`, кабинет `/account`, адаптивный редактор.
- Обновлённые Cloudflare Functions (auth, каталог, шаринг, платежи).
- Документация: README, мануалы для админов/пользователей, схемы БД.
- CI pipeline, набор тестов, мониторинг.

## 7. Метрики успеха
- 0 открытых публичных endpoint без авторизации.
- Lighthouse Performance/Best Practices ≥ 80, Accessibility ≥ 85 на мобильных.
- ≥90% успешных платежей Stripe без ручных вмешательств, корректный учёт в `purchases`.
- Покрытие тестами ≥ 40%, e2e сценарии (вход, покупка, кабинет, шаринг) проходят стабильно.
- Уровень ошибок (Sentry) <1% от активных сессий.
