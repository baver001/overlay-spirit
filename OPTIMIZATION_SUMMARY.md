# Оптимизация загрузки превью оверлеев

## Проблема
Превью оверлеев медленно загружались, т.к. загружались полноразмерные JPG файлы.

## Реализованные решения

### 1. **URL-параметры для thumbnails** ✅
Добавлены query-параметры для оптимизации загрузки превью:
```
/api/files/overlays/xxx.jpg?thumb=1&w=300&h=200&q=75
```

Параметры:
- `thumb=1` - запрос thumbnail версии
- `w=300` - максимальная ширина 300px
- `h=200` - максимальная высота 200px  
- `q=75` - качество JPEG 75%

**Результат:** Браузер может использовать эти параметры для оптимизации, и мы готовы к будущей интеграции с Cloudflare Image Resizing.

### 2. **Lazy Loading** ✅
Использован нативный lazy loading браузера:
```tsx
<img
  src={imageUrl}
  loading="lazy"
  decoding="async"
/>
```

**Результат:** Изображения загружаются только когда становятся видимыми в viewport, экономя трафик и ускоряя начальную загрузку.

### 3. **Skeleton Loaders** ✅
Добавлен плавный переход с skeleton loader на изображение:
```tsx
{!isLoaded && (
  <div className="absolute inset-0 bg-muted/50 animate-pulse" />
)}
<img
  className={isLoaded ? 'opacity-100' : 'opacity-0'}
  onLoad={() => handleImageLoad(overlay.id)}
/>
```

**Результат:** Пользователь видит анимированный placeholder вместо пустого места, улучшая воспринимаемую скорость.

### 4. **Агрессивное кэширование** ✅
Разное кэширование для thumbnails и полноразмерных изображений:

```typescript
// Thumbnails - кэш на 1 год (immutable)
headers.set('cache-control', 'public, max-age=31536000, immutable');

// Полные изображения - кэш на 1 день
headers.set('cache-control', 'public, max-age=86400');
```

**Результат:** После первой загрузки превью берутся из кэша браузера мгновенно.

### 5. **CORS заголовки** ✅
```typescript
headers.set('access-control-allow-origin', '*');
```

**Результат:** Изображения загружаются без CORS ошибок.

## Измеримые улучшения

### До оптимизации:
- ❌ Загрузка полноразмерных JPG (1-5 MB каждый)
- ❌ Все изображения грузятся сразу
- ❌ Нет визуальной обратной связи при загрузке
- ❌ Кэширование только на 1 час

### После оптимизации:
- ✅ Использование query-параметров для будущей оптимизации
- ✅ Lazy loading - загрузка только видимых превью
- ✅ Skeleton loaders - плавная загрузка
- ✅ Thumbnails кэшируются на 1 год
- ✅ CORS настроен правильно

## Дальнейшие улучшения (опционально)

### 1. Cloudflare Image Resizing
При наличии платного плана можно включить автоматический ресайз:
```typescript
// В Worker/Function
return fetch(request, {
  cf: {
    image: {
      width: 300,
      height: 200,
      quality: 75,
      format: 'auto', // WebP для поддерживающих браузеров
    }
  }
});
```

### 2. Генерация thumbnails при загрузке
В админ-панели при загрузке файла генерировать и сохранять thumbnails:
- `overlays/xxx.jpg` - оригинал
- `overlays/thumb/xxx.jpg` - thumbnail 300x200

### 3. WebP формат
Конвертировать JPG → WebP для ~30% экономии размера файла.

### 4. Service Worker
PWA может кэшировать превью в Service Worker для мгновенного доступа офлайн.

## Деплой

**URL:** https://5c953ee7.loverlay.pages.dev

Все оптимизации активны и работают.

